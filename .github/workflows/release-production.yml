name: Build and Release Extension (Production)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Also triggers on version tags
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install web-ext
        run: npm install -g web-ext
      
      - name: Validate extension
        run: web-ext lint --source-dir . --self-hosted
      
      - name: Get version from manifest
        id: get_version
        run: |
          VERSION=$(node -p "require('./manifest.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $VERSION"
      
      - name: Get tag name
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, use version from manifest
            VERSION=$(node -p "require('./manifest.json').version")
            TAG="v${VERSION}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For tag pushes, use the tag name
            TAG="${GITHUB_REF#refs/tags/}"
          else
            # For branch pushes, use version from manifest
            VERSION=$(node -p "require('./manifest.json').version")
            TAG="v${VERSION}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
      
      - name: Sign extension with Firefox AMO
        run: |
          VERSION=$(node -p "require('./manifest.json').version")
          mkdir -p artifacts/signed
          
          # Sign the extension using web-ext
          # This will take ~3 minutes as Firefox validates and signs
          web-ext sign \
            --source-dir . \
            --artifacts-dir ./artifacts/signed \
            --api-key "${{ secrets.AMO_API_KEY }}" \
            --api-secret "${{ secrets.AMO_API_SECRET }}" \
            --channel unlisted \
            --timeout 600000
          
          # Find the signed XPI file (web-ext creates it with a generated name)
          SIGNED_XPI=$(find artifacts/signed -name "*.xpi" -type f | head -n 1)
          
          if [ -z "$SIGNED_XPI" ]; then
            echo "Error: Signed XPI not found"
            exit 1
          fi
          
          # Rename to a consistent name
          cp "$SIGNED_XPI" "artifacts/signed/wimood_cart_manager-${VERSION}-signed.xpi"
          
          echo "‚úì Extension signed successfully"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }} (Production)
          body: |
            ## Wimood Cart Manager ${{ steps.get_version.outputs.version }} - Production Release
            
            ### üîê Signed Version (Recommended for End Users)
            
            This version is **signed by Mozilla** and verified for production use.
            
            **Download:** `wimood_cart_manager-${{ steps.get_version.outputs.version }}-signed.xpi`
            
            **Installation:**
            1. Download the `.xpi` file above
            2. Open Firefox and go to `about:addons`
            3. Click the gear icon and select "Install Add-on From File..."
            4. Select the downloaded `.xpi` file
            
            ### Changes
            See the commit history for details.
          files: |
            artifacts/signed/wimood_cart_manager-${{ steps.get_version.outputs.version }}-signed.xpi
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
